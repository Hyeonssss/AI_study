# day20_web_TIL



#### 프로젝트 생성

##### anaconda prompt

- cd python-Django로 이동 후
- django-admin startproject [lecture(프로젝트명)]



##### pycharm

##### Terminal

- users application 추가
- python manage.py startapp users



#### 프로젝트 설정

##### settings.py

- allowed_hosts 변경 - 'localhost', '127.0.0.1'

- installed_apps 추가 - 'users.apps.UsersConfig'

- templates DIRS 변경 - os.path.join(BASE_DIR, 'templates')

  templates 폴더 생성

- timezone 변경 - Asia/Seoul

- staticfiles_dirs 추가 - [ os.path.join(BASE_DIR, 'static') ]

  js, css, image 폴더 생성

```python
"""
Django settings for lecture project.

Generated by 'django-admin startproject' using Django 2.2.5.

For more information on this file, see
https://docs.djangoproject.com/en/2.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/2.2/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/2.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 's69=*kv^-(uo2w=yq^@bn$%&!igu#p)04bkt9=ivp-=xr7@439'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['localhost', '127.0.0.1']


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'users.apps.UsersConfig'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'lecture.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'lecture.wsgi.application'


# Database
# https://docs.djangoproject.com/en/2.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/2.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/2.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'Asia/Seoul'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/2.2/howto/static-files/

STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static')
]
```



#### 기본 데이터베이스 생성

- Users, Groups table 생성 + 관리자 계정 생성

##### Terminal

- python manage.py createsuperuser

- python manage.py migrate
- python manage.py runserver

 

##### lecture/urls.py

- urlpatterns 추가

- view 함수를 거치지 않고 바로 html을 호출

  정적인 페이지 호출 시에 적합, 동적인 페이지 구현 불가

  from django.views.generic.base import TemplateView

  path('', TemplateView.as_view(template_name='index.html'), name='home'),

- include('users.urls') - 각 앱마다 urls 파일 내에서 url 처리하도록 설정

```python
from django.contrib import admin
from django.urls import path, include
from django.views.generic.base import TemplateView

urlpatterns = [
    # url(), path(), re_path()
    # view 함수 호출 없이 html 호출
    path('', TemplateView.as_view(template_name='index.html'),
         name='home'),
    path('admin/', admin.site.urls),
    path('users/', include('users.urls'))
]
```



##### index.html

- bootstrap에서 테이블 소스 코드 보기 복붙
- download에서 CDN 복붙
- css 파일 저장 후 경로 설정 - '/static/css/cover.css'
- 문장 수정



##### users/urls.py

- path('login', views.login, name='login')



##### views.py

- login 함수에 단순 render 추가
- login 함수

```python
def login(request):
    return render(request, 'users/login.html', {
        'page_title': 'User Login'
    })
```



##### base.html

- bootstrap에서 페이지 소스 보기 후 메인 페이지 외 페이지들의 기본이 되는 base.html 생성

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ page_title }}</title>

    <!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

    <!-- Bootstrap core CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    
      
    <!-- 부가적인 CSS 설정 -->
    {% block html_header %}
    
    {% endblock %}
  </head>
  
  {% block html_body %}

  {% endblock %}
</html>
```





##### login.html

- users -> templates -> users -> login.html 폴더 경로 및 파일 생성

- index.html 로그인 버튼에 url 링크 추가 - '/users/login'

  ```html
  <a href="/users/login" class="btn btn-lg btn-secondary fw-bold border-white bg-white">로그인</a>
  ```



- login.html에서 base.html을 확장해서 사용

  users.js 파일을 참조해서 사용 - static/js/users.js 생성

```html
{% extends 'base.html' %}

{% block html_header %}

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="/static/css/signin.css" rel="stylesheet">

    <script src="/static/js/users.js"></script>
    
{% endblock %}

{% block html_body %}


 <body class="text-center">
    
<main class="form-signin">
  <form>
    <h1 class="h3 mb-3 fw-normal">로그인 하세요</h1>
    <label for="inputId" class="visually-hidden">User ID</label>
    <input type="text" id="inputId" class="form-control" placeholder="User ID" required autofocus>
    <label for="inputPassword" class="visually-hidden">Password</label>
    <input type="password" id="inputPassword" class="form-control" placeholder="Password" required>
    <div class="checkbox mb-3">
      <label>
        <input type="checkbox" value="remember-me"> Remember me
      </label>
    </div>
    <button class="w-100 btn btn-lg btn-primary" type="submit">Sign in</button>
    <br>
    <button class="w-100 btn btn-lg btn-warning" type="button"
            onclick="user_register()">회원가입</button>
  </form>
</main>
 </body>

{% endblock %}


</html>

```





##### users.js

- user_register() 함수 호출시 signup http 호출

```javascript
function user_register() {
    location.href = '/users/signup'
    // http://localhost:8000/users/signup
}
```



- users/urls.py에 signup 경로 생성

  path('signup/', views.signup, name='signup')



- views.py에 signup 함수 생성

```python
def signup(request):
    return render(request, 'users/signup.html', {
        'page_title': '회원가입',
    })
```





##### signup.html

- form 태그에 action과 method 추가

```html
{% extends 'base.html' %}

{% block html_header %}

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="/static/css/signin.css" rel="stylesheet">

    <script src="/static/js/users.js"></script>

{% endblock %}

{% block html_body %}


 <body class="text-center">
    
<main class="form-signin">
  <form action="/users/signupProcess/" method="post">
    <h1 class="h3 mb-3 fw-normal">로그인 하세요</h1>
    <label for="inputId" class="visually-hidden">User ID</label>
    <input type="text"
           id="inputId"
           name="inputId"
           class="form-control"
           placeholder="User ID"
           required autofocus>
    <label for="inputPassword1" class="visually-hidden">Password</label>
    <input type="password"
           id="inputPassword1"
           name="inputPassword1"
           class="form-control"
           placeholder="Password"
           required>
    <label for="inputPassword2" class="visually-hidden">Password</label>
    <input type="password"
           id="inputPassword2"
           name="inputPassword2"
           class="form-control"
           placeholder="Password"
           required>

    <div class="checkbox mb-3">
    </div>
    <button class="w-100 btn btn-lg btn-primary" type="submit">회원가입</button>
    <br>
  </form>
</main>
 </body>

{% endblock %}


</html>

```



- urls.py에 signupProcess url 추가

- views.py에 signup_process 함수 추가

  호출하려면 input 태그에 name 속성이 있어야함

- request.POST['ID값'] 으로 데이터 추출

  데이터가 넘어오는지 print를 사용해서 terminal에서 값 확인

```python
def signup_process(request):
    user_id = request.POST['inputId']
    u_pass1 = request.POST['inputPassword1']
    u_pass2 = request.POST['inputPassword2']
    print('회원가입 함수 호출 성공')
    print(user_id)
    print(u_pass1)
    print(u_pass2)
```



##### user table

- sqlite에서 확인

  ID는 username, PW는 password에 삽입

- views.py에서 User 테이블 import

  from django.contrib.auth.models import User

- id가 이미 존재하면 처리

```python
    user_list = User.objects.all()
    # username 에 사용자가 입력한 user_id가 exists 존재하는가
    if user_list.filter(username=user_id).exists():
        # 회원가입하려는 ID가 존재하면 회원가입 창으로 돌아감
        return render(request, 'users/signup.html', {
            'err_msg': '존재하는 ID 입니다.'
        })
```

- signup.html에도 동일한 처리

```html
<main class="form-signin">
  <form action="/users/signupProcess/" method="post">
  {% csrf_token %}
    <h1 class="h3 mb-3 fw-normal">회원가입입니다.</h1>
      {% if err_msg %}
        <h1 class="h3 mb-3 fw-normal">{{ err_msg }}</h1>
      {% endif %}
```



- id가 존재하지 않으면 회원가입 진행

  data 인자를 넘기지 않는 페이지 전환은 redirect

  data를 넘겨야하면 render 사용

```python
    elif u_pass1 == u_pass2:
        # 회원가입이 가능
        User.objects.create_user(username=user_id,
                                 password=u_pass1)
        return redirect('home')
```



- 최종 signup_process 함수

```python
def signup_process(request):
    user_id = request.POST['inputId']
    u_pass1 = request.POST['inputPassword1']
    u_pass2 = request.POST['inputPassword2']


    user_list = User.objects.all()
    if user_list.filter(username=user_id).exists():
        return render(request, 'users/signup.html', {
            'err_msg': '존재하는 ID 입니다.'
        })
    elif u_pass1 == u_pass2:
        User.objects.create_user(username=user_id,
                                 password=u_pass1)
        return redirect('home')
    else:
        # 회원가입을 위해 입력한 비밀번호 2개가 서로 다른 경우
        return render(request, 'users/signup.html', {
            'err_msg': '비밀번호 두 개가 일치하지 않습니다.'
        })
```



##### loginProcess

- login.html form에 action과 method 추가

  form action="/users/loginProcess" method="post"

  사용자가 입력한 id와 pw에 name 속성 추가하여 views.py에서 호출

- views.py 에 인증을 담당하는 auth 모듈 import

  from django.contrib import auth

- 데이터베이스에 해당 ID와 PW가 있는지 확인

  auth.authenticate(request, username=u_id, password=u_pw)

```python
def login_process(request):
    # 클라이언트로부터 post 방식으로 id 와 pw 가 전달됨
    u_id = request.POST['inputId']
    u_pw = request.POST['inputPassword']

    # 로그인이 되는지 확인 ( 데이터베이스에 해당 ID 와 PW 가 있는지 확인 )
    user = auth.authenticate(request, username=u_id, password=u_pw)

    # 로그인을 성공했을 경우
    if user is not None:
        # 로그인 처리를 진행 ( session 처리 진행 )
        # 로그인에만 국한된 세션처리 방법
        auth.login(request, user)

        # 일반적인 세션처리 방법
        user_dict = {
            'u_id': user.id,
            'u_name': user.username,
        }
        # session 처리
        request.session['loginObj'] = user_dict
        return redirect('home')
    else:
        return render(request, 'users/login.html', {
            'err_msg': '로그인 실패입니다.'
        })
```



- login.html에 에러처리 추가 

```html
  <form action="/users/loginProcess/" method="post">
  {% csrf_token %}
      {% if err_msg %}
              <h1 class="h3 mb-3 fw-normal">{{ err_msg }}</h1>
      {% endif %} 
    <h1 class="h3 mb-3 fw-normal">로그인 하세요</h1>
```



- index.html에서 로그인 처리하기

```html
	{% if request.session.loginObj %}
        {# 로그인이 된 경우 #}
        <p class="lead">
            <a href="" 
             class="btn btn-lg btn-secondary 
             fw-bold border-white bg-white">BoxOffice</a>
            <a href=""  
             class="btn btn-lg btn-secondary 
             fw-bold border-white bg-white">BBS</a>
        </p>
    {% else %}
        {# 로그인이 안된 경우 #}
        <p class="lead">
          <a href="/users/login" class="btn btn-lg btn-secondary fw-bold border-white bg-white">로그인</a>
        </p>
    {% endif %} 
```



##### login.html

```html
{% extends 'base.html' %}

{% block html_header %}

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="/static/css/signin.css" rel="stylesheet">

    <script src="/static/js/users.js"></script>

{% endblock %}

{% block html_body %}


 <body class="text-center">
    
<main class="form-signin">
  <form action="/users/loginProcess/" method="post">
  {% csrf_token %}
  {% if err_msg %}
          <h1 class="h3 mb-3 fw-normal">{{ err_msg }}</h1>
  {% endif %}
    <h1 class="h3 mb-3 fw-normal">로그인 하세요</h1>
    <label for="inputId" class="visually-hidden">User ID</label>
    <input type="text"
           id="inputId"
           name="inputId"
           class="form-control"
           placeholder="User ID"
           required autofocus>
    <label for="inputPassword" class="visually-hidden">Password</label>
    <input type="password"
           id="inputPassword"
           name="inputPassword"
           class="form-control"
           placeholder="Password"
           required>
    <div class="checkbox mb-3">
      <label>
        <input type="checkbox" value="remember-me"> Remember me
      </label>
    </div>
    <button class="w-100 btn btn-lg btn-primary" type="submit">Sign in</button>
    <br>
    <button class="w-100 btn btn-lg btn-warning" type="button"
            onclick="user_register()">회원가입</button>
  </form>
</main>
 </body>

{% endblock %}


</html>
```



##### index.html

```html
<!doctype html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8">
    <title>Lecture Sample</title>

    <!-- Bootstrap core CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="/static/css/cover.css" rel="stylesheet">
  </head>
  <body class="d-flex h-100 text-center text-white bg-dark">
    
<div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
  <header class="mb-auto">
    <div>
      <h3 class="float-md-start mb-0">Lecture Sample</h3>
      <nav class="nav nav-masthead justify-content-center float-md-end">
      </nav>
    </div>
  </header>

  <main class="px-3">
    <h1>Lecture Sample</h1>
    <p class="lead">지금까지 예제입니다.</p>

    {% if request.session.loginObj %}
        {# 로그인이 된 경우 #}
        <p class="lead">
            <a href=""
             class="btn btn-lg btn-secondary
             fw-bold border-white bg-white">BoxOffice</a>
            <a href=""
             class="btn btn-lg btn-secondary
             fw-bold border-white bg-white">BBS</a>
            <a href="/users/logout"
             class="btn btn-lg btn-secondary
             fw-bold border-white bg-white">로그아웃</a>
        </p>
    {% else %}
        {# 로그인이 안된 경우 #}
        <p class="lead">
          <a href="/users/login" class="btn btn-lg btn-secondary fw-bold border-white bg-white">로그인</a>
        </p>
    {% endif %}


  </main>

  <footer class="mt-auto text-white-50">
    <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
  </footer>
</div>


    
  </body>
</html>
```



- lecture/urls.py

```python
from django.contrib import admin
from django.urls import path, include
from . import views


urlpatterns = [
    path('', views.home, name='home'),
    path('admin/', admin.site.urls),
    path('users/', include('users.urls'))
]
```



- lecture/views.py

```python
from django.shortcuts import render


def home(request):
    return render(request, 'index.html')
```



- users/views.py

  로그아웃 함수 추가

```python
def logout(request):
    # session 정보를 삭제
    auth.logout(request)
    return redirect('home')
```

